import{u as de,a as oe,r as f,h as P,t,j as e}from"./index-Dywk6Wct.js";import{s as me,f as Y,g as C,T as B,C as L,h as E,i as z,j as q,k as G,B as i,p as ue}from"./card-COVlAyCK.js";import{u as A}from"./useMutation-B9Pg_4-n.js";import{D as _,a as M,b as O,c as Q,f as K,d as H,e as I}from"./dialog-FhCmn6ho.js";import{L as r,I as w}from"./label-B_hCal8h.js";import{T as J}from"./textarea-KGtfPTML.js";import{C as W}from"./checkbox-DxxAqD9j.js";import{T as xe,a as he,b as U,c as g,d as pe,e as m}from"./table-DsZwcbVs.js";import{P as je,T as fe}from"./trash-2-DD78mPSE.js";import"./index-C9wnK8pN.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],be=me("pencil",ge),b=[{id:"qr",label:"二维码"},{id:"copy",label:"复制"},{id:"import",label:"导入"}],Ne=b.reduce((u,o)=>(u[o.id]=o.label,u),{});function Be(){const{auth:u}=de(),o=oe(),[X,T]=f.useState(!1),[F,N]=f.useState(null),[y,S]=f.useState(null),[n,l]=f.useState({name:"",description:"",buttons:b.map(s=>s.id)}),[k,v]=f.useState(null),{data:Z,isLoading:ee,isError:se}=Y({queryKey:["profile"],queryFn:ue,enabled:!!u.accessToken,staleTime:300*1e3}),R=!!Z?.is_admin,{data:ae,isLoading:ne}=Y({queryKey:["admin-subscriptions"],queryFn:async()=>(await C.get("/api/subscriptions")).data,enabled:!!(u.accessToken&&R),staleTime:60*1e3}),$=ae?.subscriptions??[],x=()=>{l({name:"",description:"",buttons:b.map(s=>s.id)}),v(null)},ie=()=>{x(),N(null),T(!0)},V=(s,a)=>{l(c=>{const d=new Set(c.buttons);return a?d.add(s):d.delete(s),{...c,buttons:Array.from(d)}})},te=s=>{l({name:s.name,description:s.description,buttons:s.buttons??[]}),v(null),N(s)},D=()=>{o.invalidateQueries({queryKey:["admin-subscriptions"]}),o.invalidateQueries({queryKey:["subscriptions"]}),o.invalidateQueries({queryKey:["rule-metadata"]})},h=A({mutationFn:async s=>{const a=new FormData;a.append("name",s.data.name.trim()),a.append("description",s.data.description.trim());for(const d of s.data.buttons)a.append("buttons",d);return a.append("rule_file",s.file),(await C.post("/api/admin/subscriptions",a)).data},onSuccess:()=>{t.success("订阅已创建"),T(!1),x(),D()},onError:P}),p=A({mutationFn:async s=>{const a=new FormData;a.append("name",s.data.name.trim()),a.append("description",s.data.description.trim());for(const d of s.data.buttons)a.append("buttons",d);return s.file&&a.append("rule_file",s.file),(await C.put(`/api/admin/subscriptions/${s.id}`,a)).data},onSuccess:()=>{t.success("订阅已更新"),N(null),x(),D()},onError:P}),j=A({mutationFn:async s=>{await C.delete(`/api/admin/subscriptions/${s}`)},onSuccess:()=>{t.success("订阅已删除"),S(null),D()},onError:P}),re=s=>{if(s.preventDefault(),!n.name.trim()){t.error("请输入订阅名称");return}if(!k){t.error("请上传规则文件");return}if(n.buttons.length===0){t.error("请至少选择一个功能按钮");return}h.mutate({data:n,file:k})},le=s=>{if(s.preventDefault(),!!F){if(!n.name.trim()){t.error("请输入订阅名称");return}if(n.buttons.length===0){t.error("请至少选择一个功能按钮");return}p.mutate({id:F.id,data:n,file:k})}},ce=()=>{y&&j.mutate(y.id)};return ee||ne?e.jsxs("div",{className:"min-h-svh bg-background",children:[e.jsx(B,{}),e.jsx("main",{className:"mx-auto w-full max-w-5xl px-4 py-8 sm:px-6",children:e.jsxs(L,{className:"border-dashed shadow-none",children:[e.jsxs(E,{children:[e.jsx(z,{children:"加载中…"}),e.jsx(q,{children:"正在获取订阅配置，请稍候。"})]}),e.jsx(G,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"h-10 w-full animate-pulse rounded-md bg-muted"}),e.jsx("div",{className:"h-10 w-full animate-pulse rounded-md bg-muted"}),e.jsx("div",{className:"h-10 w-full animate-pulse rounded-md bg-muted"})]})})]})})]}):!R||se?e.jsxs("div",{className:"min-h-svh bg-background",children:[e.jsx(B,{}),e.jsx("main",{className:"mx-auto flex w-full max-w-3xl flex-col items-center justify-center gap-4 px-4 py-20 text-center sm:px-6",children:e.jsx(L,{className:"w-full border-dashed shadow-none",children:e.jsxs(E,{children:[e.jsx(z,{children:"权限不足"}),e.jsx(q,{children:"只有管理员可以访问订阅管理页面。"})]})})})]}):e.jsxs("div",{className:"min-h-svh bg-background",children:[e.jsx(B,{}),e.jsxs("main",{className:"mx-auto w-full max-w-6xl px-4 py-8 sm:px-6",children:[e.jsxs("section",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-semibold tracking-tight",children:"订阅管理"}),e.jsx("p",{className:"text-muted-foreground",children:"新增、更新或删除订阅链接，上传规则文件并配置功能按钮。"})]}),e.jsxs(i,{size:"sm",onClick:ie,disabled:h.isPending,children:[e.jsx(je,{className:"mr-2 size-4"}),"新增订阅"]})]}),e.jsxs(L,{className:"mt-8",children:[e.jsxs(E,{children:[e.jsx(z,{children:"订阅列表"}),e.jsx(q,{children:"所有变更会立即影响订阅链接。"})]}),e.jsx(G,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(xe,{children:[e.jsx(he,{children:e.jsxs(U,{children:[e.jsx(g,{className:"w-[180px]",children:"名称"}),e.jsx(g,{children:"简介"}),e.jsx(g,{className:"w-[200px]",children:"功能按钮"}),e.jsx(g,{className:"w-[220px]",children:"规则文件"}),e.jsx(g,{className:"w-[120px] text-right",children:"操作"})]})}),e.jsxs(pe,{children:[$.map(s=>{const a=(s.buttons??[]).map(c=>Ne[c]??c);return e.jsxs(U,{children:[e.jsx(m,{className:"font-medium",children:s.name}),e.jsx(m,{className:"max-w-[280px] truncate text-muted-foreground",children:s.description||"—"}),e.jsx(m,{children:a.length>0?a.join("、"):"未配置"}),e.jsx(m,{className:"font-mono text-xs text-muted-foreground",children:s.rule_filename}),e.jsxs(m,{className:"space-x-2 text-right",children:[e.jsx(i,{size:"icon",variant:"outline",className:"size-8",onClick:()=>te(s),disabled:p.isPending,children:e.jsx(be,{className:"size-4"})}),e.jsx(i,{size:"icon",variant:"destructive",className:"size-8",onClick:()=>S(s),disabled:j.isPending,children:e.jsx(fe,{className:"size-4"})})]})]},s.id)}),$.length===0?e.jsx(U,{children:e.jsx(m,{colSpan:5,className:"py-10 text-center text-muted-foreground",children:"当前没有订阅记录。"})}):null]})]})})})]})]}),e.jsx(_,{open:X,onOpenChange:s=>{T(s),s||x()},children:e.jsxs(M,{className:"sm:max-w-lg",children:[e.jsxs(O,{children:[e.jsx(Q,{children:"新增订阅"}),e.jsx(K,{children:"配置订阅名称、简介、功能按钮以及规则文件。"})]}),e.jsxs("form",{className:"space-y-4",onSubmit:re,children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"create-name",children:"名称"}),e.jsx(w,{id:"create-name",value:n.name,onChange:s=>l(a=>({...a,name:s.target.value})),placeholder:"例如：clash",autoFocus:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"create-description",children:"简介"}),e.jsx(J,{id:"create-description",value:n.description,onChange:s=>l(a=>({...a,description:s.target.value})),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{children:"功能按钮"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:b.map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx(W,{checked:n.buttons.includes(s.id),onCheckedChange:a=>V(s.id,!!a)}),s.label]},s.id))}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"可自由选择展示的按钮，至少保留一个。"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"create-file",children:"规则文件"}),e.jsx(w,{id:"create-file",type:"file",accept:".yaml,.yml",onChange:s=>v(s.target.files?.[0]??null)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"仅支持 YAML 文件，上传后将自动存储到订阅目录。"})]}),e.jsxs(H,{className:"gap-2",children:[e.jsx(I,{asChild:!0,children:e.jsx(i,{type:"button",variant:"outline",disabled:h.isPending,children:"取消"})}),e.jsx(i,{type:"submit",disabled:h.isPending,children:h.isPending?"创建中…":"确认创建"})]})]})]})}),e.jsx(_,{open:!!F,onOpenChange:s=>{s||(N(null),x())},children:e.jsxs(M,{className:"sm:max-w-lg",children:[e.jsxs(O,{children:[e.jsx(Q,{children:"编辑订阅"}),e.jsx(K,{children:"更新订阅信息，可选上传新规则文件覆盖旧文件。"})]}),e.jsxs("form",{className:"space-y-4",onSubmit:le,children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"edit-name",children:"名称"}),e.jsx(w,{id:"edit-name",value:n.name,onChange:s=>l(a=>({...a,name:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"edit-description",children:"简介"}),e.jsx(J,{id:"edit-description",value:n.description,onChange:s=>l(a=>({...a,description:s.target.value})),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{children:"功能按钮"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:b.map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx(W,{checked:n.buttons.includes(s.id),onCheckedChange:a=>V(s.id,!!a)}),s.label]},s.id))}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"不勾选的按钮将在订阅卡片中隐藏。"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"edit-file",children:"规则文件"}),e.jsx(w,{id:"edit-file",type:"file",accept:".yaml,.yml",onChange:s=>v(s.target.files?.[0]??null)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"若不上传则保留原有规则文件。"})]}),e.jsxs(H,{className:"gap-2",children:[e.jsx(I,{asChild:!0,children:e.jsx(i,{type:"button",variant:"outline",disabled:p.isPending,children:"取消"})}),e.jsx(i,{type:"submit",disabled:p.isPending,children:p.isPending?"保存中…":"保存修改"})]})]})]})}),e.jsx(_,{open:!!y,onOpenChange:s=>{s||S(null)},children:e.jsxs(M,{className:"sm:max-w-md",children:[e.jsxs(O,{children:[e.jsx(Q,{children:"确认删除"}),e.jsxs(K,{children:["确认删除订阅「",y?.name,"」？关联的规则文件在无其他订阅使用时会被删除。"]})]}),e.jsxs(H,{className:"gap-2",children:[e.jsx(I,{asChild:!0,children:e.jsx(i,{type:"button",variant:"outline",disabled:j.isPending,children:"取消"})}),e.jsx(i,{type:"button",variant:"destructive",disabled:j.isPending,onClick:ce,children:j.isPending?"删除中…":"确认删除"})]})]})})]})}export{Be as component};
