import{u as de,a as ce,r,t as o,h as me,j as e}from"./index-BIA9nVWk.js";import{h as W,u as z,a as p,B as i,A as ue,o as pe,p as he,q as xe,r as je,s as fe,t as ge,v as ve,w as ye}from"./api-CF1mdzCj.js";import{u as D}from"./useMutation-BUAWeYRL.js";import{l as K}from"./js-yaml-DOuxXFsS.js";import{I as h}from"./input-B0zk7gIF.js";import{T as L}from"./textarea-B07UdKsX.js";import{C as be,a as Ce,b as Ne,c as De,d as Fe}from"./card-D4NqIVBJ.js";import{T as we,a as ke,b as R,c as x,d as Ee,e as j}from"./table-ESroElt8.js";import{B as V}from"./badge-BHqjMmc7.js";import{D as M,g as $,a as q,b as P,c as O,f as I,d as B}from"./dialog-BP6ZPIJ4.js";import{L as m}from"./label-D1Cndv1r.js";import{D as Se}from"./download-C12iawhZ.js";import"./utils-CBfrqCZ4.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],Ae=W("square-pen",Te);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],Me=W("upload",Le),qe={create:"bg-blue-500/10 text-blue-700 dark:text-blue-400",import:"bg-green-500/10 text-green-700 dark:text-green-400",upload:"bg-purple-500/10 text-purple-700 dark:text-purple-400"},Pe={create:"创建",import:"导入",upload:"上传"};function We(){const{auth:_}=de(),b=ce(),[G,F]=r.useState(!1),[J,w]=r.useState(!1),[X,k]=r.useState(!1),[a,Z]=r.useState(null),[u,C]=r.useState(""),[H,f]=r.useState(!1),[E,l]=r.useState(null),[t,g]=r.useState({name:"",description:"",url:"",filename:""}),[d,N]=r.useState({name:"",description:"",filename:""}),[v,Q]=r.useState(null),{data:ee,isLoading:se}=z({queryKey:["subscribe-files"],queryFn:async()=>(await p.get("/api/admin/subscribe-files")).data,enabled:!!_.accessToken}),S=ee?.files??[],T=D({mutationFn:async s=>(await p.post("/api/admin/subscribe-files/import",s)).data,onSuccess:()=>{b.invalidateQueries({queryKey:["subscribe-files"]}),o.success("订阅导入成功"),F(!1),g({name:"",description:"",url:"",filename:""})},onError:s=>{o.error(s.response?.data?.error||"导入失败")}}),A=D({mutationFn:async()=>{if(!v)throw new Error("请选择文件");const s=new FormData;return s.append("file",v),s.append("name",d.name||v.name),s.append("description",d.description),s.append("filename",d.filename||v.name),(await p.post("/api/admin/subscribe-files/upload",s,{headers:{"Content-Type":"multipart/form-data"}})).data},onSuccess:()=>{b.invalidateQueries({queryKey:["subscribe-files"]}),o.success("文件上传成功"),w(!1),N({name:"",description:"",filename:""}),Q(null)},onError:s=>{o.error(s.response?.data?.error||"上传失败")}}),U=D({mutationFn:async s=>{await p.delete(`/api/admin/subscribe-files/${s}`)},onSuccess:()=>{b.invalidateQueries({queryKey:["subscribe-files"]}),o.success("订阅已删除")},onError:s=>{o.error(s.response?.data?.error||"删除失败")}}),n=z({queryKey:["rule-file",a?.filename],queryFn:async()=>a?(await p.get(`/api/rules/${encodeURIComponent(a.filename)}`)).data:null,enabled:!!(a&&_.accessToken),refetchOnWindowFocus:!1}),y=D({mutationFn:async s=>(await p.put(`/api/rules/${encodeURIComponent(s.file)}`,{content:s.content})).data,onSuccess:()=>{o.success("规则已保存"),f(!1),l(null),b.invalidateQueries({queryKey:["rule-file",a?.filename]})},onError:s=>{me(s)}});r.useEffect(()=>{n.data&&(C(n.data.content??""),f(!1),l(null))},[n.data]),r.useEffect(()=>{if(!a||n.isLoading)return;const s=setTimeout(()=>{if(!u.trim()){l("内容不能为空");return}try{K(u),l(null)}catch(Y){const oe=Y instanceof Error?Y.message:"YAML 解析失败";l(oe)}},300);return()=>clearTimeout(s)},[u,a,n.isLoading]);const ae=s=>{Z(s),k(!0),C(""),f(!1),l(null)},ne=()=>{if(a){try{K(u||""),l(null)}catch(s){const c=s instanceof Error?s.message:"YAML 解析失败";l(c),o.error("保存失败，YAML 格式错误");return}y.mutate({file:a.filename,content:u})}},re=()=>{n.data&&(C(n.data.content??""),f(!1),l(null))},te=()=>{if(!t.name||!t.url){o.error("请填写订阅名称和链接");return}T.mutate(t)},ie=()=>{if(!v){o.error("请选择文件");return}A.mutate()},le=s=>{U.mutate(s)};return e.jsxs("main",{className:"mx-auto w-full max-w-7xl px-4 py-8 sm:px-6",children:[e.jsxs("section",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-semibold tracking-tight",children:"订阅管理"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"管理 Clash 订阅文件，支持从链接导入或上传本地文件"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(M,{open:G,onOpenChange:F,children:[e.jsx($,{asChild:!0,children:e.jsxs(i,{variant:"outline",children:[e.jsx(Se,{className:"mr-2 h-4 w-4"}),"导入订阅"]})}),e.jsxs(q,{children:[e.jsxs(P,{children:[e.jsx(O,{children:"导入订阅"}),e.jsx(I,{children:"从 Clash 订阅链接导入，系统会自动下载并保存文件"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"import-name",children:"订阅名称 *"}),e.jsx(h,{id:"import-name",placeholder:"例如：机场A",value:t.name,onChange:s=>g({...t,name:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"import-url",children:"订阅链接 *"}),e.jsx(h,{id:"import-url",placeholder:"https://example.com/subscribe?token=xxx",value:t.url,onChange:s=>g({...t,url:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"import-filename",children:"文件名（可选）"}),e.jsx(h,{id:"import-filename",placeholder:"留空则自动获取",value:t.filename,onChange:s=>g({...t,filename:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"import-description",children:"说明（可选）"}),e.jsx(L,{id:"import-description",placeholder:"订阅说明信息",value:t.description,onChange:s=>g({...t,description:s.target.value})})]})]}),e.jsxs(B,{children:[e.jsx(i,{variant:"outline",onClick:()=>F(!1),children:"取消"}),e.jsx(i,{onClick:te,disabled:T.isPending,children:T.isPending?"导入中...":"导入"})]})]})]}),e.jsxs(M,{open:J,onOpenChange:w,children:[e.jsx($,{asChild:!0,children:e.jsxs(i,{variant:"outline",children:[e.jsx(Me,{className:"mr-2 h-4 w-4"}),"上传文件"]})}),e.jsxs(q,{children:[e.jsxs(P,{children:[e.jsx(O,{children:"上传文件"}),e.jsx(I,{children:"上传本地 YAML 格式的 Clash 订阅文件"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"upload-file",children:"选择文件 *"}),e.jsx(h,{id:"upload-file",type:"file",accept:".yaml,.yml",onChange:s=>Q(s.target.files?.[0]||null)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"upload-name",children:"订阅名称（可选）"}),e.jsx(h,{id:"upload-name",placeholder:"留空则使用文件名",value:d.name,onChange:s=>N({...d,name:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"upload-filename",children:"文件名（可选）"}),e.jsx(h,{id:"upload-filename",placeholder:"留空则使用原文件名",value:d.filename,onChange:s=>N({...d,filename:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"upload-description",children:"说明（可选）"}),e.jsx(L,{id:"upload-description",placeholder:"订阅说明信息",value:d.description,onChange:s=>N({...d,description:s.target.value})})]})]}),e.jsxs(B,{children:[e.jsx(i,{variant:"outline",onClick:()=>w(!1),children:"取消"}),e.jsx(i,{onClick:ie,disabled:A.isPending,children:A.isPending?"上传中...":"上传"})]})]})]})]})]}),e.jsxs(be,{children:[e.jsxs(Ce,{children:[e.jsxs(Ne,{children:["订阅列表 (",S.length,")"]}),e.jsx(De,{children:"已添加的订阅文件"})]}),e.jsx(Fe,{children:se?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"加载中..."}):S.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"暂无订阅，点击上方按钮添加"}):e.jsx("div",{className:"rounded-md border",children:e.jsxs(we,{children:[e.jsx(ke,{children:e.jsxs(R,{children:[e.jsx(x,{children:"订阅名称"}),e.jsx(x,{children:"说明"}),e.jsx(x,{children:"链接地址"}),e.jsx(x,{children:"类型"}),e.jsx(x,{children:"文件名"}),e.jsx(x,{className:"text-center",children:"操作"})]})}),e.jsx(Ee,{children:S.map(s=>e.jsxs(R,{children:[e.jsx(j,{className:"font-medium",children:s.name}),e.jsx(j,{children:e.jsx("div",{className:"max-w-[200px] truncate text-sm text-muted-foreground",children:s.description||"-"})}),e.jsx(j,{children:e.jsx("div",{className:"max-w-[300px] truncate text-sm font-mono",children:s.url||"-"})}),e.jsx(j,{children:e.jsx(V,{variant:"outline",className:qe[s.type],children:Pe[s.type]})}),e.jsx(j,{className:"font-mono text-sm",children:s.filename}),e.jsx(j,{className:"text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs(i,{variant:"ghost",size:"sm",onClick:()=>ae(s),children:[e.jsx(Ae,{className:"mr-1 h-4 w-4"}),"编辑"]}),e.jsxs(ue,{children:[e.jsx(pe,{asChild:!0,children:e.jsx(i,{variant:"ghost",size:"sm",disabled:U.isPending,children:"删除"})}),e.jsxs(he,{children:[e.jsxs(xe,{children:[e.jsx(je,{children:"确认删除"}),e.jsxs(fe,{children:['确定要删除订阅 "',s.name,'" 吗？此操作将同时删除对应的文件，不可撤销。']})]}),e.jsxs(ge,{children:[e.jsx(ve,{children:"取消"}),e.jsx(ye,{onClick:()=>le(s.id),children:"删除"})]})]})]})]})})]},s.id))})]})})})]})]}),e.jsx(M,{open:X,onOpenChange:k,children:e.jsxs(q,{className:"max-w-4xl max-h-[90vh]",children:[e.jsxs(P,{children:[e.jsx(O,{children:a?.name||"编辑文件"}),e.jsxs(I,{children:["编辑 ",a?.filename," 的内容，会自动验证 YAML 格式"]})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(i,{size:"sm",onClick:ne,disabled:!a||!H||y.isPending||n.isLoading,children:y.isPending?"保存中...":"保存修改"}),e.jsx(i,{size:"sm",variant:"outline",disabled:!H||n.isLoading||y.isPending,onClick:re,children:"还原修改"}),n.data?.latest_version?e.jsxs(V,{variant:"secondary",children:["版本 v",n.data.latest_version]}):null]}),E?e.jsx("div",{className:"rounded-md border border-destructive/60 bg-destructive/10 p-3 text-sm text-destructive",children:E}):null,e.jsx("div",{className:"rounded-lg border bg-muted/20 overflow-hidden",children:n.isLoading?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"加载中..."}):e.jsx(L,{value:u,onChange:s=>{const c=s.target.value;C(c),f(c!==(n.data?.content??"")),E&&l(null)},className:"min-h-[500px] max-h-[500px] font-mono text-sm resize-none overflow-y-auto",disabled:!a||y.isPending,spellCheck:!1})})]}),e.jsx(B,{children:e.jsx(i,{variant:"outline",onClick:()=>k(!1),children:"关闭"})})]})})]})}export{We as component};
