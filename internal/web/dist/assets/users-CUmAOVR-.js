import{u as J,a as V,r as g,h as v,t as b,j as e}from"./index-BIA9nVWk.js";import{u as K,a as f,B as d}from"./api-CF1mdzCj.js";import{u as C}from"./useMutation-BUAWeYRL.js";import{T as k,p as W}from"./topbar-Fz-IxQaZ.js";import{C as T,a as S,b as F,c as P,d as A}from"./card-D4NqIVBJ.js";import{D as H,a as L,b as O,c as R,d as _,e as z}from"./dialog-BP6ZPIJ4.js";import{I as o}from"./input-B0zk7gIF.js";import{L as m}from"./label-D1Cndv1r.js";import{T as X,a as Y,b as q,c as u,d as Z,e as n}from"./table-ESroElt8.js";import{S as $}from"./switch-CuvsaitH.js";import"./utils-CBfrqCZ4.js";import"./index-B103vlTN.js";const w=(h=12)=>{const r="ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789";return Array.from({length:h},()=>r[Math.floor(Math.random()*r.length)]).join("")};function ue(){const{auth:h}=J(),r=V(),[t,p]=g.useState(null),[I,y]=g.useState(!1),[i,l]=g.useState({username:"",email:"",nickname:"",password:w()}),{data:D,isLoading:U,isError:G}=K({queryKey:["profile"],queryFn:W,enabled:!!h.accessToken,staleTime:300*1e3}),E=!!D?.is_admin,B=K({queryKey:["admin-users"],queryFn:async()=>(await f.get("/api/admin/users")).data,enabled:!!(E&&h.accessToken),staleTime:30*1e3}),M=C({mutationFn:async s=>{await f.post("/api/admin/users/status",s)},onSuccess:()=>{r.invalidateQueries({queryKey:["admin-users"]}),b.success("用户状态已更新")},onError:v}),x=C({mutationFn:async s=>(await f.post("/api/admin/users/reset-password",{username:s.username,new_password:s.password})).data,onSuccess:s=>{b.success("密码已重置"),r.invalidateQueries({queryKey:["admin-users"]}),p(null),typeof navigator<"u"&&navigator.clipboard?.writeText&&navigator.clipboard.writeText(s.password).catch(()=>null)},onError:s=>{v(s)}}),j=C({mutationFn:async s=>(await f.post("/api/admin/users/create",s)).data,onSuccess:s=>{b.success("用户已创建，初始密码已复制"),r.invalidateQueries({queryKey:["admin-users"]}),y(!1),l({username:"",email:"",nickname:"",password:w()}),typeof navigator<"u"&&navigator.clipboard?.writeText&&navigator.clipboard.writeText(s.password).catch(()=>null)},onError:s=>{v(s)}}),Q=g.useMemo(()=>B.data?.users??[],[B.data]);return U?e.jsxs("div",{className:"min-h-svh bg-background",children:[e.jsx(k,{}),e.jsx("main",{className:"mx-auto w-full max-w-5xl px-4 py-8 sm:px-6",children:e.jsxs(T,{className:"shadow-none border-dashed",children:[e.jsxs(S,{children:[e.jsx(F,{children:"加载中…"}),e.jsx(P,{children:"正在获取管理员信息，请稍候。"})]}),e.jsx(A,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded-md bg-muted animate-pulse"}),e.jsx("div",{className:"h-10 w-full rounded-md bg-muted animate-pulse"}),e.jsx("div",{className:"h-10 w-full rounded-md bg-muted animate-pulse"})]})})]})})]}):!E||G?e.jsxs("div",{className:"min-h-svh bg-background",children:[e.jsx(k,{}),e.jsx("main",{className:"mx-auto flex w-full max-w-3xl flex-col items-center justify-center gap-4 px-4 py-20 text-center sm:px-6",children:e.jsx(T,{className:"w-full shadow-none border-dashed",children:e.jsxs(S,{children:[e.jsx(F,{children:"权限不足"}),e.jsx(P,{children:"只有管理员可以访问用户管理页面。"})]})})})]}):e.jsxs("div",{className:"min-h-svh bg-background",children:[e.jsx(k,{}),e.jsxs("main",{className:"mx-auto w-full max-w-6xl px-4 py-8 sm:px-6",children:[e.jsxs("section",{className:"space-y-3",children:[e.jsx("h1",{className:"text-3xl font-semibold tracking-tight",children:"用户管理"}),e.jsx("p",{className:"text-muted-foreground",children:"查看系统用户，调整启用状态并重置密码。"})]}),e.jsxs(T,{className:"mt-8",children:[e.jsx(S,{children:e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx(F,{children:"账号列表"}),e.jsx(P,{children:"仅管理员可更改用户状态或重置密码。"})]}),e.jsx(d,{size:"sm",onClick:()=>{l({username:"",email:"",nickname:"",password:w()}),y(!0)},children:"新增用户"})]})}),e.jsx(A,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(X,{children:[e.jsx(Y,{children:e.jsxs(q,{children:[e.jsx(u,{className:"w-[180px]",children:"用户名"}),e.jsx(u,{className:"w-[180px]",children:"昵称"}),e.jsx(u,{className:"w-[240px]",children:"邮箱"}),e.jsx(u,{className:"w-[140px] text-center",children:"角色"}),e.jsx(u,{className:"w-[140px] text-center",children:"状态"}),e.jsx(u,{className:"w-[160px] text-right",children:"操作"})]})}),e.jsxs(Z,{children:[Q.map(s=>{const a=s.username===D?.username,c=s.role==="admin";return e.jsxs(q,{children:[e.jsx(n,{className:"font-medium",children:s.username}),e.jsx(n,{children:s.nickname||"—"}),e.jsx(n,{className:"text-muted-foreground",children:s.email||"—"}),e.jsx(n,{className:"text-center",children:e.jsx("span",{className:"text-sm font-medium",children:c?"管理员":"普通用户"})}),e.jsx(n,{className:"text-center",children:e.jsx($,{checked:s.is_active,disabled:M.isPending||a||c,onCheckedChange:N=>M.mutate({username:s.username,is_active:N})})}),e.jsx(n,{className:"text-right",children:c?e.jsx("span",{className:"text-sm text-muted-foreground",children:"—"}):e.jsx(d,{size:"sm",variant:"outline",disabled:x.isPending,onClick:()=>p({username:s.username,password:w()}),children:"重置密码"})})]},s.username)}),Q.length===0?e.jsx(q,{children:e.jsx(n,{colSpan:6,className:"py-10 text-center text-muted-foreground",children:"当前没有可显示的用户。"})}):null,e.jsx(H,{open:I,onOpenChange:s=>y(s),children:e.jsxs(L,{className:"sm:max-w-md",children:[e.jsx(O,{children:e.jsx(R,{children:"新增用户"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"create-username",children:"用户名"}),e.jsx(o,{id:"create-username",value:i.username,autoComplete:"off",onChange:s=>l(a=>{const c=s.target.value,N=a.nickname===""||a.nickname===a.username;return{...a,username:c,nickname:N?c:a.nickname}})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"create-email",children:"邮箱"}),e.jsx(o,{id:"create-email",type:"email",value:i.email,autoComplete:"off",onChange:s=>l(a=>({...a,email:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"create-nickname",children:"昵称"}),e.jsx(o,{id:"create-nickname",value:i.nickname,autoComplete:"off",onChange:s=>l(a=>({...a,nickname:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"create-password",children:"初始密码"}),e.jsx(o,{id:"create-password",type:"text",value:i.password,onChange:s=>l(a=>({...a,password:s.target.value}))}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"默认生成随机密码，可在创建前自行调整。"})]})]}),e.jsxs(_,{className:"gap-2",children:[e.jsx(z,{asChild:!0,children:e.jsx(d,{type:"button",variant:"outline",disabled:j.isPending,children:"取消"})}),e.jsx(d,{type:"button",disabled:!i.username||j.isPending,onClick:()=>j.mutate(i),children:j.isPending?"创建中…":"确认创建"})]})]})})]})]})})})]})]}),e.jsx(H,{open:!!t,onOpenChange:s=>s?null:p(null),children:e.jsxs(L,{className:"sm:max-w-md",children:[e.jsx(O,{children:e.jsx(R,{children:"重置密码"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"用户名"}),e.jsx(o,{value:t?.username??"",readOnly:!0,disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"new-password",children:"新密码"}),e.jsx(o,{id:"new-password",type:"text",value:t?.password??"",onChange:s=>p(a=>a&&{...a,password:s.target.value})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"默认生成随机密码，可自行修改后确认。"})]})]}),e.jsxs(_,{className:"gap-2",children:[e.jsx(z,{asChild:!0,children:e.jsx(d,{type:"button",variant:"outline",disabled:x.isPending,children:"取消"})}),e.jsx(d,{type:"button",disabled:!t?.password||x.isPending,onClick:()=>t&&x.mutate(t),children:x.isPending?"重置中…":"确认重置"})]})]})})]})}export{ue as component};
