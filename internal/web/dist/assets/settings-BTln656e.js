import{b as L,a as M,u as z,r as D,t as a,j as e,h as j}from"./index-Dywk6Wct.js";import{u as T}from"./index.esm-B8_5ilxN.js";import{f as F,T as I,C as w,h as g,i as f,j as y,k,A as K,l as V,m as H,B as m,g as u,p as R}from"./card-COVlAyCK.js";import{u as v}from"./useMutation-B9Pg_4-n.js";import{L as i,I as t}from"./label-B_hCal8h.js";function Y(){const C=L(),_=M(),{auth:p}=z(),{data:r,isLoading:d}=F({queryKey:["profile"],queryFn:R,enabled:!!p.accessToken,staleTime:300*1e3}),{data:P,isLoading:S}=F({queryKey:["user-token"],queryFn:async()=>(await u.get("/api/user/token")).data,enabled:!!p.accessToken,staleTime:300*1e3}),n=T({defaultValues:{username:"",nickname:"",email:"",avatar_url:""}});D.useEffect(()=>{r&&n.reset({username:r.username,nickname:r.nickname,email:r.email,avatar_url:r.avatar_url})},[r,n]);const x=v({mutationFn:async s=>{const N={username:s.username.trim(),nickname:s.nickname.trim(),email:s.email.trim(),avatar_url:s.avatar_url.trim()};return(await u.put("/api/user/settings",N)).data},onSuccess:()=>{a.success("个人信息已更新"),_.invalidateQueries({queryKey:["profile"]})},onError:s=>{j(s),a.error("更新个人信息失败")}}),c=v({mutationFn:async()=>(await u.post("/api/user/token")).data,onSuccess:s=>{_.setQueryData(["user-token"],s),a.success("Token 已重置")},onError:s=>{j(s),a.error("重置 Token 失败")}}),o=T({defaultValues:{current_password:"",new_password:"",confirm_password:""}}),h=v({mutationFn:async s=>(await u.post("/api/user/password",{current_password:s.current_password,new_password:s.new_password})).data,onSuccess:()=>{a.success("密码已更新，请重新登录"),o.reset(),p.reset(),C({to:"/",replace:!0})},onError:s=>{j(s),a.error("修改密码失败")}}),q=n.handleSubmit(s=>{if(!s.username.trim()){a.error("用户名不能为空");return}if(r?.is_admin&&s.username.trim()!==r.username){a.error("管理员用户名不可修改");return}x.mutate(s)}),E=o.handleSubmit(s=>{if(s.new_password.trim().length<8){a.error("新密码至少 8 位");return}if(s.new_password!==s.confirm_password){a.error("两次输入的新密码不一致");return}h.mutate(s)}),b=r?.nickname||r?.username||"用户",A=r?.is_admin?"/images/admin-avatar.webp":"/images/user-avatar.png",Q=r?.avatar_url?.trim()?r.avatar_url.trim():A,B=b.slice(0,2)||"用户",l=P?.token??"";return e.jsxs("div",{className:"min-h-svh bg-background",children:[e.jsx(I,{}),e.jsxs("main",{className:"mx-auto w-full max-w-4xl px-4 py-8 sm:px-6",children:[e.jsxs("section",{className:"space-y-2",children:[e.jsx("h1",{className:"text-3xl font-semibold tracking-tight",children:"个人设置"}),e.jsx("p",{className:"text-muted-foreground",children:"更新个人信息、查看订阅 Token，并可在此修改密码。"})]}),e.jsxs("div",{className:"mt-8 grid gap-6 lg:grid-cols-2",children:[e.jsxs(w,{children:[e.jsxs(g,{children:[e.jsx(f,{children:"个人资料"}),e.jsx(y,{children:"修改用户名、昵称、邮箱和头像链接。"})]}),e.jsx(k,{children:e.jsxs("form",{className:"space-y-5",onSubmit:q,children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(K,{className:"size-12",children:[e.jsx(V,{src:Q,alt:b}),e.jsx(H,{children:B})]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:r?.is_admin?"管理员头像默认根据角色区分，设置自定义链接将覆盖默认头像。":"支持使用任意公开可访问的图片链接。"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"username",children:"用户名"}),e.jsx(t,{id:"username",placeholder:"用于登录的用户名",disabled:d||r?.is_admin,...n.register("username",{required:!0})}),r?.is_admin?e.jsx("p",{className:"text-xs text-muted-foreground",children:"管理员用户名暂不支持修改。"}):null]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"nickname",children:"昵称"}),e.jsx(t,{id:"nickname",placeholder:"用于展示的昵称",disabled:d,...n.register("nickname")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"email",children:"邮箱"}),e.jsx(t,{id:"email",type:"email",placeholder:"用于接收通知 (可选)",disabled:d,...n.register("email")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"avatar_url",children:"头像链接"}),e.jsx(t,{id:"avatar_url",placeholder:"https://example.com/avatar.png",disabled:d,...n.register("avatar_url")})]}),e.jsx(m,{type:"submit",className:"w-full",disabled:x.isPending,children:x.isPending?"保存中…":"保存变更"})]})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(w,{children:[e.jsxs(g,{children:[e.jsx(f,{children:"修改密码"}),e.jsx(y,{children:"修改后需要使用新密码重新登录系统。"})]}),e.jsx(k,{children:e.jsxs("form",{className:"space-y-4",onSubmit:E,children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"current_password",children:"当前密码"}),e.jsx(t,{id:"current_password",type:"password",autoComplete:"current-password",placeholder:"请输入当前密码",...o.register("current_password",{required:!0})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"new_password",children:"新密码"}),e.jsx(t,{id:"new_password",type:"password",autoComplete:"new-password",placeholder:"至少 8 位，建议包含符号",...o.register("new_password",{required:!0})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"confirm_password",children:"确认新密码"}),e.jsx(t,{id:"confirm_password",type:"password",autoComplete:"new-password",placeholder:"再次输入新密码",...o.register("confirm_password",{required:!0})})]}),e.jsx(m,{type:"submit",className:"w-full",disabled:h.isPending,children:h.isPending?"修改中…":"更新密码"})]})})]}),e.jsxs(w,{children:[e.jsxs(g,{children:[e.jsx(f,{children:"订阅 Token"}),e.jsx(y,{children:"Token 用于客户端订阅，请妥善保管。"})]}),e.jsxs(k,{className:"space-y-4",children:[e.jsx("div",{className:"font-mono text-xs sm:text-sm break-all rounded-md border bg-muted/40 p-3 shadow-inner",children:S?"加载中…":l||"尚未生成"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(m,{size:"sm",variant:"secondary",disabled:!l||c.isPending,onClick:async()=>{if(l){if(typeof navigator<"u"&&navigator.clipboard?.writeText)try{await navigator.clipboard.writeText(l),a.success("Token 已复制");return}catch(s){console.error("copy token failed",s)}a.error("复制失败，请手动复制")}},children:"复制 Token"}),e.jsx(m,{size:"sm",variant:"outline",disabled:c.isPending,onClick:()=>c.mutate(),children:c.isPending?"重置中…":"重置 Token"})]})]})]})]})]})]})]})}export{Y as component};
