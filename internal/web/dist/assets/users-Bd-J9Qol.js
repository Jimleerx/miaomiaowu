import{r as l,j as e,u as ae,a as te,h as R,t as F}from"./index-BN9BZ8Rr.js";import{u as J,a as ne,c as re,P as V,b as ie,d as ce,e as Q,f as L,g as P,T as _,C as M,h as q,i as D,j as H,k as O,B as v,p as oe}from"./card-DvLCnMS9.js";import{u as A}from"./useMutation-tbNEdVwD.js";import{D as z,a as K,b as U,c as W,d as X,e as G}from"./dialog-CLDueJVA.js";import{L as y,I as N}from"./label-B6ZwrKZd.js";import{T as le,a as de,b as I,c as k,d as ue,e as w}from"./table-DsD6oqQc.js";import{u as me}from"./index-bCQBNJ7u.js";var B="Switch",[he]=re(B),[xe,pe]=he(B),Y=l.forwardRef((n,r)=>{const{__scopeSwitch:t,name:o,checked:u,defaultChecked:j,required:c,disabled:i,value:h="on",onCheckedChange:C,form:x,...b}=n,[f,g]=l.useState(null),m=J(r,d=>g(d)),p=l.useRef(!1),S=f?x||!!f.closest("form"):!0,[s,a]=ne({prop:u,defaultProp:j??!1,onChange:C,caller:B});return e.jsxs(xe,{scope:t,checked:s,disabled:i,children:[e.jsx(V.button,{type:"button",role:"switch","aria-checked":s,"aria-required":c,"data-state":se(s),"data-disabled":i?"":void 0,disabled:i,value:h,...b,ref:m,onClick:ie(n.onClick,d=>{a(T=>!T),S&&(p.current=d.isPropagationStopped(),p.current||d.stopPropagation())})}),S&&e.jsx(ee,{control:f,bubbles:!p.current,name:o,value:h,checked:s,required:c,disabled:i,form:x,style:{transform:"translateX(-100%)"}})]})});Y.displayName=B;var Z="SwitchThumb",$=l.forwardRef((n,r)=>{const{__scopeSwitch:t,...o}=n,u=pe(Z,t);return e.jsx(V.span,{"data-state":se(u.checked),"data-disabled":u.disabled?"":void 0,...o,ref:r})});$.displayName=Z;var je="SwitchBubbleInput",ee=l.forwardRef(({__scopeSwitch:n,control:r,checked:t,bubbles:o=!0,...u},j)=>{const c=l.useRef(null),i=J(c,j),h=me(t),C=ce(r);return l.useEffect(()=>{const x=c.current;if(!x)return;const b=window.HTMLInputElement.prototype,g=Object.getOwnPropertyDescriptor(b,"checked").set;if(h!==t&&g){const m=new Event("click",{bubbles:o});g.call(x,t),x.dispatchEvent(m)}},[h,t,o]),e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:t,...u,tabIndex:-1,ref:i,style:{...u.style,...C,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});ee.displayName=je;function se(n){return n?"checked":"unchecked"}var fe=Y,ge=$;function we({className:n,...r}){return e.jsx(fe,{"data-slot":"switch",className:Q("peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent shadow-xs transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",n),...r,children:e.jsx(ge,{"data-slot":"switch-thumb",className:Q("bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0 rtl:data-[state=checked]:-translate-x-[calc(100%-2px)]")})})}const E=(n=12)=>{const r="ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789";return Array.from({length:n},()=>r[Math.floor(Math.random()*r.length)]).join("")};function Te(){const{auth:n}=ae(),r=te(),[t,o]=l.useState(null),[u,j]=l.useState(!1),[c,i]=l.useState({username:"",email:"",nickname:"",password:E()}),{data:h,isLoading:C,isError:x}=L({queryKey:["profile"],queryFn:oe,enabled:!!n.accessToken,staleTime:300*1e3}),b=!!h?.is_admin,f=L({queryKey:["admin-users"],queryFn:async()=>(await P.get("/api/admin/users")).data,enabled:!!(b&&n.accessToken),staleTime:30*1e3}),g=A({mutationFn:async s=>{await P.post("/api/admin/users/status",s)},onSuccess:()=>{r.invalidateQueries({queryKey:["admin-users"]}),F.success("用户状态已更新")},onError:R}),m=A({mutationFn:async s=>(await P.post("/api/admin/users/reset-password",{username:s.username,new_password:s.password})).data,onSuccess:s=>{F.success("密码已重置"),r.invalidateQueries({queryKey:["admin-users"]}),o(null),typeof navigator<"u"&&navigator.clipboard?.writeText&&navigator.clipboard.writeText(s.password).catch(()=>null)},onError:s=>{R(s)}}),p=A({mutationFn:async s=>(await P.post("/api/admin/users/create",s)).data,onSuccess:s=>{F.success("用户已创建，初始密码已复制"),r.invalidateQueries({queryKey:["admin-users"]}),j(!1),i({username:"",email:"",nickname:"",password:E()}),typeof navigator<"u"&&navigator.clipboard?.writeText&&navigator.clipboard.writeText(s.password).catch(()=>null)},onError:s=>{R(s)}}),S=l.useMemo(()=>f.data?.users??[],[f.data]);return C?e.jsxs("div",{className:"min-h-svh bg-background",children:[e.jsx(_,{}),e.jsx("main",{className:"mx-auto w-full max-w-5xl px-4 py-8 sm:px-6",children:e.jsxs(M,{className:"shadow-none border-dashed",children:[e.jsxs(q,{children:[e.jsx(D,{children:"加载中…"}),e.jsx(H,{children:"正在获取管理员信息，请稍候。"})]}),e.jsx(O,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded-md bg-muted animate-pulse"}),e.jsx("div",{className:"h-10 w-full rounded-md bg-muted animate-pulse"}),e.jsx("div",{className:"h-10 w-full rounded-md bg-muted animate-pulse"})]})})]})})]}):!b||x?e.jsxs("div",{className:"min-h-svh bg-background",children:[e.jsx(_,{}),e.jsx("main",{className:"mx-auto flex w-full max-w-3xl flex-col items-center justify-center gap-4 px-4 py-20 text-center sm:px-6",children:e.jsx(M,{className:"w-full shadow-none border-dashed",children:e.jsxs(q,{children:[e.jsx(D,{children:"权限不足"}),e.jsx(H,{children:"只有管理员可以访问用户管理页面。"})]})})})]}):e.jsxs("div",{className:"min-h-svh bg-background",children:[e.jsx(_,{}),e.jsxs("main",{className:"mx-auto w-full max-w-6xl px-4 py-8 sm:px-6",children:[e.jsxs("section",{className:"space-y-3",children:[e.jsx("h1",{className:"text-3xl font-semibold tracking-tight",children:"用户管理"}),e.jsx("p",{className:"text-muted-foreground",children:"查看系统用户，调整启用状态并重置密码。"})]}),e.jsxs(M,{className:"mt-8",children:[e.jsx(q,{children:e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx(D,{children:"账号列表"}),e.jsx(H,{children:"仅管理员可更改用户状态或重置密码。"})]}),e.jsx(v,{size:"sm",onClick:()=>{i({username:"",email:"",nickname:"",password:E()}),j(!0)},children:"新增用户"})]})}),e.jsx(O,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(le,{children:[e.jsx(de,{children:e.jsxs(I,{children:[e.jsx(k,{className:"w-[180px]",children:"用户名"}),e.jsx(k,{className:"w-[180px]",children:"昵称"}),e.jsx(k,{className:"w-[240px]",children:"邮箱"}),e.jsx(k,{className:"w-[140px] text-center",children:"角色"}),e.jsx(k,{className:"w-[140px] text-center",children:"状态"}),e.jsx(k,{className:"w-[160px] text-right",children:"操作"})]})}),e.jsxs(ue,{children:[S.map(s=>{const a=s.username===h?.username,d=s.role==="admin";return e.jsxs(I,{children:[e.jsx(w,{className:"font-medium",children:s.username}),e.jsx(w,{children:s.nickname||"—"}),e.jsx(w,{className:"text-muted-foreground",children:s.email||"—"}),e.jsx(w,{className:"text-center",children:e.jsx("span",{className:"text-sm font-medium",children:d?"管理员":"普通用户"})}),e.jsx(w,{className:"text-center",children:e.jsx(we,{checked:s.is_active,disabled:g.isPending||a||d,onCheckedChange:T=>g.mutate({username:s.username,is_active:T})})}),e.jsx(w,{className:"text-right",children:e.jsx(v,{size:"sm",variant:"outline",disabled:m.isPending,onClick:()=>o({username:s.username,password:E()}),children:"重置密码"})})]},s.username)}),S.length===0?e.jsx(I,{children:e.jsx(w,{colSpan:6,className:"py-10 text-center text-muted-foreground",children:"当前没有可显示的用户。"})}):null,e.jsx(z,{open:u,onOpenChange:s=>j(s),children:e.jsxs(K,{className:"sm:max-w-md",children:[e.jsx(U,{children:e.jsx(W,{children:"新增用户"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"create-username",children:"用户名"}),e.jsx(N,{id:"create-username",value:c.username,autoComplete:"off",onChange:s=>i(a=>{const d=s.target.value,T=a.nickname===""||a.nickname===a.username;return{...a,username:d,nickname:T?d:a.nickname}})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"create-email",children:"邮箱"}),e.jsx(N,{id:"create-email",type:"email",value:c.email,autoComplete:"off",onChange:s=>i(a=>({...a,email:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"create-nickname",children:"昵称"}),e.jsx(N,{id:"create-nickname",value:c.nickname,autoComplete:"off",onChange:s=>i(a=>({...a,nickname:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"create-password",children:"初始密码"}),e.jsx(N,{id:"create-password",type:"text",value:c.password,onChange:s=>i(a=>({...a,password:s.target.value}))}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"默认生成随机密码，可在创建前自行调整。"})]})]}),e.jsxs(X,{className:"gap-2",children:[e.jsx(G,{asChild:!0,children:e.jsx(v,{type:"button",variant:"outline",disabled:p.isPending,children:"取消"})}),e.jsx(v,{type:"button",disabled:!c.username||p.isPending,onClick:()=>p.mutate(c),children:p.isPending?"创建中…":"确认创建"})]})]})})]})]})})})]})]}),e.jsx(z,{open:!!t,onOpenChange:s=>s?null:o(null),children:e.jsxs(K,{className:"sm:max-w-md",children:[e.jsx(U,{children:e.jsx(W,{children:"重置密码"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"用户名"}),e.jsx(N,{value:t?.username??"",readOnly:!0,disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"new-password",children:"新密码"}),e.jsx(N,{id:"new-password",type:"text",value:t?.password??"",onChange:s=>o(a=>a&&{...a,password:s.target.value})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"默认生成随机密码，可自行修改后确认。"})]})]}),e.jsxs(X,{className:"gap-2",children:[e.jsx(G,{asChild:!0,children:e.jsx(v,{type:"button",variant:"outline",disabled:m.isPending,children:"取消"})}),e.jsx(v,{type:"button",disabled:!t?.password||m.isPending,onClick:()=>t&&m.mutate(t),children:m.isPending?"重置中…":"确认重置"})]})]})})]})}export{Te as component};
